apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata: 
  name: sample-httpd-pipeline
spec:
  description: |
    This pipeline clones a git repo, then build and push image to the OpenShift internal registry.
  params: 
  - name: repo-url 
    type: string
    description: The git repo URL to clone from. 
  workspaces: 
  - name: oc_dir
  - name: shared-data
    description: |
      This workspaces contains the cloned repo files, so they can be read by the next task.
  - name: git-credentials
    description: My ssh git-credentials
  tasks: 
  - name: switch-namespace
    taskRef: 
      name: namespace-creation
    workspaces: 
    - name: k8s 
      workspace: oc_dir
  - name: fetch-source
    taskRef: 
      name: git-clone 
    workspaces: 
    - name: output
      workspace: shared-data
    - name: ssh-directory
      workspace: git-credentials
    params:
    - name: url 
      value: $(params.repo-url)
  - name: build-and-push-image
    params:
    - name: CONTEXT
      value: "apps/sample-app-httpd/docker"
    - name: IMAGE
      value: >-
        image-registry.openshift-image-registry.svc:5000/${NAMESPACE}/dck_eazytraining-lab-http:1.0
    runAfter: 
    - fetch-source
      